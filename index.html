<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rifa Lavadora OCEAN — Compra tus números</title>
  <style>
    :root{--blue:#0070f3}
    *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{background:linear-gradient(180deg,#0f9bd7,#0b6bb4);color:#fff;padding:18px 20px}
    header h1{margin:0;font-size:22px}
    nav{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;font-size:14px}
    nav a{color:#fff;text-decoration:none;opacity:.95}
    .hero{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card .p{padding:16px}
    .hero h2{margin:0 0 6px}
    .prize{display:flex;gap:16px;align-items:center}
    .prize img{max-width:280px;border-radius:12px;border:1px solid #eee}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .tag{background:#eef5ff;border:1px solid #d6e6ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(64px,1fr));gap:10px}
    .ticket{padding:12px 0;border-radius:10px;text-align:center;cursor:pointer;font-weight:700;border:2px solid transparent;user-select:none;transition:transform .05s ease}
    .ticket:active{transform:scale(.98)}
    .available{background:#e6f7ed;border-color:#bfead0}
    .reserved{background:#fff7d6;border-color:#ffe08a;cursor:not-allowed}
    .sold{background:#ffd7d7;border-color:#ffa6a6;color:#7a0000;cursor:not-allowed}
    .selected{outline:3px solid var(--blue)}
    .actions{position:sticky;bottom:0;background:#fff;padding:12px 16px;border-top:1px solid #eaeaea;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border:0;border-radius:10px;background:var(--blue);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#111} button.warn{background:#f59e0b}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:#555;font-size:13px} .status{margin-left:auto;font-size:13px}
    .section{padding:16px} .footer{padding:16px;color:#666;font-size:12px;text-align:center}
    .hint{font-size:12px;color:#eee}
    .form{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    input{padding:10px;border:1px solid #ddd;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <h1>Rifa Lavadora OCEAN</h1>
    <nav>
      <a href="#inicio">Inicio</a><a href="#premio">Premio</a><a href="#comprar">Comprar Boletos</a><a href="#contacto">Contacto</a>
    </nav>
    <div class="hint">Verde = libre • Amarillo = reservado • Rojo = vendido</div>
  </header>

  <section id="inicio" class="hero">
    <div class="card"><div class="p">
      <h2>¡Gran Rifa de una Lavadora Automática OCEAN!</h2>
      <p>Participa y llévate este premio para resolver la casa como un campeón.</p>
    </div></div>
  </section>

  <section id="premio" class="section card"><div class="p prize">
    <img src="ocean1.jpg" alt="Lavadora Automática OCEAN">
    <div>
      <h2>Premio Principal</h2>
      <p>Lavadora automática OCEAN 8 kg, múltiples programas, ahorro de agua y energía.</p>
      <p><b>Valor referencial:</b> 490 USD</p>
    </div>
  </div></section>

  <section id="comprar" class="section">
    <div class="bar">
      <span class="tag" id="totalTag">Boletos: —</span>
      <span class="tag" id="freeTag">Libres: —</span>
      <span class="tag" id="reservedTag">Reservados: —</span>
      <span class="tag" id="soldTag">Vendidos: —</span>
      <span class="status" id="status"></span>
    </div>

    <div class="form">
      <input id="name" type="text" placeholder="Tu nombre" autocomplete="name">
      <input id="phone" type="tel" placeholder="Tu WhatsApp (opcional)">
    </div>

    <div id="grid" class="grid"></div>
  </section>

  <div class="actions">
    <button id="reserveBtn" disabled>Reservar selección (10 min)</button>
    <button id="clearBtn" class="secondary">Limpiar selección</button>
    <button id="sellBtn" class="warn" title="Solo admin con PIN">Confirmar pago</button>
    <div class="muted">Las reservas caducan si no pagas a tiempo.</div>
  </div>

  <section id="contacto" class="section card"><div class="p">
    <h2>Contacto</h2>
    <p>Mensajes y soporte por WhatsApp/Telegram.</p>
  </div></section>

  <div class="footer">Sitio: santiago-rifas.vercel.app</div>

  <!-- ===== Firebase + Lógica completa en un solo archivo ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      initializeFirestore, persistentLocalCache, persistentMultipleTabManager,
      doc, getDoc, setDoc, runTransaction, onSnapshot, collection, query, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    /* === <<< PEGA AQUÍ TU firebaseConfig (el real) y borra este ejemplo >>> === */
    const firebaseConfig = {
  apiKey: "AIzaSyA1qpdTkaZp40oefb8rAT…",
  authDomain: "santiago-rifas.firebaseapp.com",
  projectId: "santiago-rifas",
  storageBucket: "santiago-rifas.appspot.com",
  messagingSenderId: "1000570902327",
  appId: "1:1000570902327:web:b668bf…",
  measurementId: "G-2EZG6TP8R5"
};
    /* ========================================================================== */

    /* ====== Ajustes negocio / WhatsApp ====== */
    const ADMIN_PIN = "123456";           // cámbialo
    const TOTAL_TICKETS = 100;
    const RESERVE_MINUTES = 10;
    const RAFFLE_ID = "ocean_1";
    const PRICE_PER_TICKET = 100;         // CUP por boleto
    const WHATSAPP_ADMIN = "5353086152";  // sin '+'
    const PAYMENT_INSTRUCTIONS =
      "Método de pago: Transfermóvil o en efectivo. Enviar comprobante por aquí.";
    /* ======================================== */

    // Firestore robusto (móviles/redes caprichosas)
    const app = initializeApp(firebaseConfig);
    const db  = initializeFirestore(app, {
      localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() }),
      experimentalAutoDetectLongPolling: true,
      useFetchStreams: false
    });

    const USER_ID = localStorage.getItem("raf_uid") || (()=>{
      const id = crypto.randomUUID(); localStorage.setItem("raf_uid", id); return id;
    })();

    const $ = s=>document.querySelector(s);
    const grid = $('#grid'), reserveBtn = $('#reserveBtn'), clearBtn = $('#clearBtn'), sellBtn = $('#sellBtn');
    const statusEl = $('#status');
    const tags = { total:$('#totalTag'), free:$('#freeTag'), res:$('#reservedTag'), sold:$('#soldTag') };
    const selected = new Set();
    const nameInp = $('#name'); const phoneInp = $('#phone');

    const ticketId = n => `${RAFFLE_ID}_${n}`;
    const numLabel = n => n.toString().padStart(2,'0');

    function buildTicket(n, data){
      const el = document.createElement('div');
      el.className = 'ticket available';
      el.textContent = numLabel(n);
      const now = Date.now();
      let st = data?.status || 'available';
      const until = data?.reservedUntil ? (data.reservedUntil.toMillis ? data.reservedUntil.toMillis() : new Date(data.reservedUntil).getTime()) : 0;
      if(st==='reserved' && until<now) st='available';
      if(st==='reserved') el.className='ticket reserved';
      if(st==='sold') el.className='ticket sold';
      if(st==='available'){
        el.addEventListener('click', ()=>{
          if(el.classList.contains('selected')){ el.classList.remove('selected'); selected.delete(n); }
          else{ el.classList.add('selected'); selected.add(n); }
          reserveBtn.disabled = selected.size===0;
          statusEl.textContent = selected.size ? `Seleccionados: ${[...selected].sort((a,b)=>a-b).map(numLabel).join(', ')}` : '';
        });
      }
      return el;
    }

    function draw(map){
      grid.innerHTML = '';
      let free=0,res=0,sold=0;
      for(let i=1;i<=TOTAL_TICKETS;i++){
        const data = map.get(ticketId(i));
        grid.appendChild(buildTicket(i, data));
        const st = !data ? 'available' :
          data.status==='sold' ? 'sold' :
          (data.status==='reserved' && ((data.reservedUntil?.toMillis?.() ?? new Date(data.reservedUntil||0).getTime())>Date.now())) ? 'reserved' : 'available';
        if(st==='available') free++; if(st==='reserved') res++; if(st==='sold') sold++;
      }
      tags.total.textContent = `Boletos: ${TOTAL_TICKETS}`;
      tags.free.textContent  = `Libres: ${free}`;
      tags.res.textContent   = `Reservados: ${res}`;
      tags.sold.textContent  = `Vendidos: ${sold}`;
    }

    onSnapshot(query(collection(db,"tickets")), snap=>{
      const map=new Map(); snap.forEach(d=>map.set(d.id,d.data())); draw(map);
    });

    // Crea docs si faltan
    (async()=>{
      for(let i=1;i<=TOTAL_TICKETS;i++){
        const ref = doc(db,"tickets",ticketId(i));
        const ss = await getDoc(ref);
        if(!ss.exists()){
          await setDoc(ref,{status:"available",raffle:RAFFLE_ID,number:i,updatedAt:serverTimestamp()});
        }
      }
    })();

    // Acciones
    clearBtn.addEventListener('click', ()=>{
      selected.clear(); document.querySelectorAll('.ticket.selected').forEach(e=>e.classList.remove('selected'));
      reserveBtn.disabled=true; statusEl.textContent='';
    });

    function openWhatsAppMessage(numbers, minutesLeft){
      const sorted = [...numbers].sort((a,b)=>a-b);
      const total = sorted.length * PRICE_PER_TICKET;
      const cliente = (nameInp.value || "Cliente");
      const telCli  = phoneInp.value ? `\nWhatsApp cliente: ${phoneInp.value}` : "";
      const texto = 
`Hola, soy ${cliente}.
Acabo de reservar estos números: ${sorted.map(numLabel).join(', ')}.
Total: ${total} CUP (${sorted.length} x ${PRICE_PER_TICKET}).
Reserva válida por ${minutesLeft} min.

${PAYMENT_INSTRUCTIONS}
Enlace del sitio: ${location.origin}${location.pathname}#comprar${telCli}`;
      const url = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(texto)}`;
      const win = window.open(url, '_blank');
      if(!win) alert("Activa ventanas emergentes para abrir WhatsApp automáticamente.");
    }

    reserveBtn.addEventListener('click', async ()=>{
      if(!selected.size) return; reserveBtn.disabled=true;
      try{
        await Promise.all([...selected].map(n=>{
          const ref = doc(db,"tickets",ticketId(n));
          return runTransaction(db, async tx=>{
            const snap = await tx.get(ref); const d=snap.data()||{status:"available"}; const now=Date.now();
            const until = d?.reservedUntil ? (d.reservedUntil.toMillis ? d.reservedUntil.toMillis() : new Date(d.reservedUntil).getTime()) : 0;
            const can = d.status==="available" || (d.status==="reserved" && until<now);
            if(!can) throw new Error(`El ${numLabel(n)} ya no está disponible`);
            tx.set(ref,{
              status:"reserved", reservedBy:USER_ID,
              reservedUntil:new Date(now+RESERVE_MINUTES*60*1000),
              updatedAt:serverTimestamp(), raffle:RAFFLE_ID, number:n
            },{merge:true});
          });
        }));
        openWhatsAppMessage(selected, RESERVE_MINUTES);
        alert(`¡Reservado! Tienes ${RESERVE_MINUTES} min para pagar/confirmar. Se abrió WhatsApp con tus datos.`);
      }catch(e){ alert(e.message||"Algún número ya estaba tomado."); }
      finally{ clearBtn.click(); }
    });

    // Admin: marcar vendidos con PIN
    sellBtn.addEventListener('click', async ()=>{
      const pin = prompt("PIN admin:"); if(pin!=="123456" && pin!==ADMIN_PIN){ alert("PIN incorrecto."); return; }
      const list = prompt("Números a marcar VENDIDOS (coma). Ej: 7,12,33"); if(!list) return;
      const nums = list.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n)&&n>=1&&n<=TOTAL_TICKETS);
      try{
        await Promise.all(nums.map(n=>{
          const ref = doc(db,"tickets",ticketId(n));
          return runTransaction(db, async tx=>{
            const snap = await tx.get(ref); if(!snap.exists()) throw new Error(`No existe ${n}`);
            const d=snap.data(); if(d.status==="sold") return;
            const until = d?.reservedUntil ? (d.reservedUntil.toMillis ? d.reservedUntil.toMillis() : new Date(d.reservedUntil).getTime()) : 0;
            if(d.status==="reserved" && until<Date.now()) throw new Error(`Reserva vencida: ${numLabel(n)}`);
            tx.set(ref,{status:"sold",soldAt:new Date(),updatedAt:serverTimestamp()},{merge:true});
          });
        }));
        alert("Venta confirmada.");
      }catch(e){ alert(e.message||"Error vendiendo."); }
    });
  </script>
</body>
</html>
